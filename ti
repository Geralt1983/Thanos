#!/bin/bash
# ti - Launch Thanos Interactive Mode
# Finds Python in common Windows locations

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Try common Windows Python locations
find_python() {
    # Check if py launcher works (preferred on Windows)
    if py --version &> /dev/null 2>&1; then
        echo "py"
        return 0
    fi
    
    # Check common installation paths (including arm64 variants)
    for path in \
        "/c/Users/JeremyKimble/AppData/Local/Programs/Python/Python"*/python.exe \
        "/c/Users/$USERNAME/AppData/Local/Programs/Python/Python"*/python.exe \
        "/c/Python3"*/python.exe \
        "/c/Python"*/python.exe \
        "/c/Program Files/Python"*/python.exe \
        "/c/Users/$USERNAME/scoop/apps/python/current/python.exe"
    do
        if [[ -x "$path" ]] && "$path" --version &> /dev/null 2>&1; then
            echo "$path"
            return 0
        fi
    done
    
    # Fallback: try python3/python if they work
    if python3 --version &> /dev/null 2>&1; then
        echo "python3"
        return 0
    fi
    if python --version &> /dev/null 2>&1; then
        echo "python"
        return 0
    fi
    
    return 1
}

PYTHON_CMD=$(find_python)

if [[ -z "$PYTHON_CMD" ]]; then
    echo "Error: Could not find a working Python installation."
    echo ""
    echo "Please install Python from https://python.org/downloads"
    echo "Or install via: winget install Python.Python.3.11"
    exit 1
fi

cd "$SCRIPT_DIR"

# Use quiet mode wrapper to filter MCP noise while preserving interactivity
exec $PYTHON_CMD -c "
import sys
import os
import subprocess
import select
import re

# Pattern to filter out (comprehensive list)
NOISE_PATTERNS = [
    b'No stored Oauth2 credentials',
    b'INFO:mcp',
    b'WARNING:mcp',
    b'Processing request of type',
    b'tool list change notifications',
    b'WARNING:root:No stored',
    b'WARNING:root:',
    b'ListToolsRequest',
    b'lowlevel.server',
    b'.oauth2.',
]

def is_noise(line):
    return any(p in line for p in NOISE_PATTERNS)

# Run thanos.py with filtered stderr
os.chdir('$SCRIPT_DIR')
proc = subprocess.Popen(
    [sys.executable, 'thanos.py', 'interactive'] + sys.argv[1:],
    stdin=sys.stdin,
    stdout=sys.stdout,
    stderr=subprocess.PIPE,
    bufsize=0
)

# Filter stderr in a separate thread
import threading
def filter_stderr():
    while True:
        line = proc.stderr.readline()
        if not line:
            break
        if not is_noise(line):
            sys.stderr.buffer.write(line)
            sys.stderr.buffer.flush()

t = threading.Thread(target=filter_stderr, daemon=True)
t.start()

# Wait for process
sys.exit(proc.wait())
" "$@"
